<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Quản Lý API Key</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .status-active, .status-success { background-color: #22c55e; }
        .status-invalid, .status-limited { background-color: #ef4444; }
        .status-error { background-color: #f97316; }
        .status-loading { background-color: #eab308; }
        .status-unknown, .status-pending { background-color: #9ca3af; }
        .status-checking { background-color: #3b82f6; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
        .toast { visibility: hidden; opacity: 0; transition: visibility 0s 0.5s, opacity 0.5s linear; }
        .toast.show { visibility: visible; opacity: 1; transition: opacity 0.5s linear; }
        
        .loader {
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }

        .key-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding-top: 0;
            padding-bottom: 0;
        }
        .key-row.expanded .key-details {
            max-height: 500px;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .key-row.expanded .expand-icon { transform: rotate(180deg); }
        .expand-icon { transition: transform 0.3s ease; }

        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-track { background: #f1f5f9; }
        .modal-body::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .modal-body::-webkit-scrollbar-thumb:hover { background: #64748b; }

        @media (max-width: 640px) {
            #user-name { display: none; }
            .action-btn { width: 2.25rem; height: 2.25rem; }
        }
    </style>
</head>
<body class="bg-[#fffbbe] text-gray-800">
    <div class="container mx-auto p-4 md:p-6 max-w-7xl">
        <header id="app-header" class="flex justify-between items-center mb-8 hidden">
            <div class="flex items-center gap-3">
                <img id="user-avatar" class="w-12 h-12 rounded-full" src="" alt="User Avatar">
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Quản Lý API</h1>
                    <p id="user-name" class="text-sm text-gray-600"></p>
                </div>
            </div>
            <div id="user-actions" class="flex items-center gap-2">
                 <button id="add-key-modal-btn" title="Thêm Key Mới" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold w-10 h-10 rounded-full transition flex items-center justify-center shadow-md">
                    <i class="fas fa-plus"></i>
                </button>
                <button id="check-all-btn" title="Kiểm tra tất cả" class="bg-green-600 hover:bg-green-700 text-white font-bold w-10 h-10 rounded-full transition flex items-center justify-center shadow-md disabled:bg-gray-400">
                    <i class="fas fa-tasks"></i>
                    <div id="check-all-loader" class="loader hidden"></div>
                </button>
                <button id="sign-out-btn" title="Đăng xuất" class="bg-red-500 hover:bg-red-600 text-white font-bold w-10 h-10 rounded-full transition flex items-center justify-center shadow-md">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <div id="login-view" class="text-center py-20">
             <h1 class="text-4xl font-bold text-gray-900">TRANG QUẢN LÝ API CỦA TRỢ LÝ PMTL.SITE</h1>
            <p class="text-gray-600 mt-2 mb-8">Phụng Sự Viên Pháp Môn Tâm Linh.</p>
            <div id="gsi-button" class="inline-block"></div>
        </div>

        <main id="app-content" class="hidden">
            <div id="key-groups-container" class="space-y-6"></div>
        </main>
    </div>

    <template id="key-row-template">
        <div class="key-row bg-white rounded-xl shadow-md p-4" data-id="" data-value="" data-type="">
            <div class="key-summary flex items-center justify-between cursor-pointer">
                <div class="flex items-center gap-3 flex-grow min-w-0">
                    <div class="status-dot"></div>
                    <span class="card-name font-semibold text-gray-800 truncate" contenteditable="true"></span>
                </div>
                <div class="flex items-center gap-3 flex-shrink-0">
                     <button title="Sao chép key" class="copy-btn p-2 text-gray-500 hover:text-indigo-600 rounded-lg hover:bg-gray-100 transition-colors"><i class="far fa-copy"></i></button>
                    <button class="expand-btn p-2 text-gray-500 hover:text-indigo-600 rounded-lg hover:bg-gray-100"><i class="fas fa-chevron-down expand-icon"></i></button>
                </div>
            </div>
            <div class="key-details border-t border-gray-200 mt-4">
                <div class="space-y-4">
                    <div>
                        <p class="text-xs font-medium text-gray-500 mb-1">API Key</p>
                        <p class="card-masked-key font-mono text-sm text-gray-600 bg-gray-50 p-2 rounded-md"></p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-500 mb-1">Ghi chú</p>
                        <textarea class="card-notes w-full bg-gray-50 p-2 rounded-md text-sm text-gray-800 border border-gray-200 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 transition" rows="2" placeholder="Thêm ghi chú..."></textarea>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-500 mb-2">Hành động</p>
                        <div class="flex items-center justify-start gap-2 flex-wrap">
                            <button title="Di chuyển lên" class="move-up-btn action-btn"><i class="fas fa-arrow-up"></i></button>
                            <button title="Di chuyển xuống" class="move-down-btn action-btn"><i class="fas fa-arrow-down"></i></button>
                            <button title="Đánh dấu yêu thích" class="favorite-btn action-btn text-gray-500"><i class="far fa-star"></i></button>
                            <button title="Kiểm tra nâng cao" class="check-btn action-btn text-blue-600"><i class="fas fa-vial"></i></button>
                            <button title="Cài đặt kiểm tra" class="settings-btn action-btn text-gray-500"><i class="fas fa-cog"></i></button>
                            <button title="Xóa" class="delete-btn action-btn text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <!-- MODALS -->
    <div id="add-key-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white rounded-xl shadow-xl p-6 w-full max-w-lg transform scale-95 opacity-0">
            <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold text-gray-900">Thêm Key Mới (Thông Minh)</h2><button class="close-modal-btn text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div>
            <div class="space-y-4">
                <div>
                    <label for="api-input-area" class="block text-sm font-medium text-gray-600 mb-1">Dán nội dung vào đây</label>
                    <textarea id="api-input-area" rows="5" placeholder="Dán email và các API key, mỗi mục một dòng..." class="w-full bg-gray-50 border-gray-300 rounded-lg py-3 px-4 text-gray-900 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm"></textarea>
                </div>
            </div>
            <button id="add-key-btn" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed"><i class="fas fa-save mr-2"></i>Lưu tất cả</button>
        </div>
    </div>

    <div id="delete-confirm-modal" data-close-on-overlay="false" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform scale-95 opacity-0">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Xác nhận xóa</h3><p class="text-gray-600 mb-6">Bạn có chắc chắn muốn xóa API key này không? Hành động này không thể hoàn tác.</p>
            <div class="flex justify-end space-x-4"><button class="cancel-delete-btn py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Hủy</button><button id="confirm-delete-btn" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Xóa</button></div>
        </div>
    </div>
    
    <div id="check-status-modal" data-close-on-overlay="false" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl transform scale-95 opacity-0 flex flex-col" style="height: 90vh; max-height: 700px;">
            <div class="flex justify-between items-center p-4 border-b rounded-t-lg bg-gray-50"><h3 class="text-xl font-bold">Kết quả Kiểm tra Nâng cao</h3><button class="close-modal-btn text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div>
            <div class="p-5 overflow-y-auto modal-body space-y-4">
                <div id="check-account-info" class="p-3 bg-indigo-50 text-indigo-800 rounded-lg text-sm font-semibold hidden"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-slate-900">Kết quả Trực quan</h4>
                        <div id="check-status-dots" class="grid grid-cols-10 md:grid-cols-15 lg:grid-cols-20 gap-3 p-4 bg-slate-100 rounded-lg"></div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-slate-900">Chú giải</h4>
                        <ul id="check-status-legend" class="space-y-2 text-sm">
                            <li><div class="flex items-center gap-2"><span class="status-dot status-success"></span><span>Thành công (2xx)</span></div></li>
                            <li><div class="flex items-center gap-2"><span class="status-dot status-limited"></span><span>Bị giới hạn (429)</span></div></li>
                            <li><div class="flex items-center gap-2"><span class="status-dot status-loading"></span><span>Model đang tải (503)</span></div></li>
                            <li><div class="flex items-center gap-2"><span class="status-dot status-error"></span><span>Lỗi khác (4xx, 5xx)</span></div></li>
                            <li><div class="flex items-center gap-2"><span class="status-dot status-pending"></span><span>Đang chờ</span></div></li>
                        </ul>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-3 text-slate-900">Nhật ký</h4>
                    <div id="check-status-log" class="font-mono text-sm space-y-2 bg-slate-800 text-white p-4 rounded-lg h-48 overflow-y-auto"></div>
                </div>
            </div>
             <div class="p-4 border-t mt-auto"><button class="stop-check-btn w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition">Dừng kiểm tra</button></div>
        </div>
    </div>

    <div id="check-settings-modal" data-close-on-overlay="false" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95 opacity-0">
             <div class="flex justify-between items-center p-4 border-b"><h3 class="text-xl font-bold">Cài đặt Kiểm tra Nâng cao</h3><button class="close-modal-btn text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div>
            <div class="p-5 space-y-4 modal-body overflow-y-auto max-h-[70vh]">
                 <div>
                    <label for="settings-provider" class="block text-sm font-medium text-slate-600 mb-1">Nhà Cung Cấp API</label>
                    <select id="settings-provider" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 text-slate-800 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>
                <div><label for="settings-url" class="block text-sm font-medium text-slate-600 mb-1">URL của API</label><input type="url" id="settings-url" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://api.example.com/v1/data"></div>
                 <div><label for="settings-requests" class="block text-sm font-medium text-slate-600 mb-1">Số lượng yêu cầu</label><input type="number" id="settings-requests" value="1" min="1" max="100" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div><label for="settings-body" class="block text-sm font-medium text-slate-600 mb-1">Request Body (JSON)</label><textarea id="settings-body" rows="5" class="w-full font-mono text-sm bg-slate-50 border border-slate-300 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea></div>
            </div>
            <div class="flex justify-end space-x-3 p-4 border-t bg-gray-50"><button class="reset-settings-btn py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Reset về mặc định</button><button class="save-settings-btn py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Lưu Cài đặt</button></div>
        </div>
    </div>

    <div id="toast" class="toast fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-2 px-5 rounded-lg shadow-lg z-[100]"></div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
    const GOOGLE_CLIENT_ID = '833528835955-t7pai7q2tb836dqggme3h3560n58s6au.apps.googleusercontent.com';
    const BACKEND_URL = 'https://quanly-backen.onrender.com';
    let idToken = null, allLoadedKeys = [], keyToModify = null, isChecking = false;

    const appHeader = document.getElementById('app-header'), loginView = document.getElementById('login-view'), appContent = document.getElementById('app-content'), gsiButton = document.getElementById('gsi-button'), userNameEl = document.getElementById('user-name'), userAvatarEl = document.getElementById('user-avatar'), signOutBtn = document.getElementById('sign-out-btn'), addKeyModalBtn = document.getElementById('add-key-modal-btn'), checkAllBtn = document.getElementById('check-all-btn'), keyGroupsContainer = document.getElementById('key-groups-container'), keyRowTemplate = document.getElementById('key-row-template'), toast = document.getElementById('toast');
    const addKeyModal = document.getElementById('add-key-modal'), deleteConfirmModal = document.getElementById('delete-confirm-modal'), checkStatusModal = document.getElementById('check-status-modal'), checkSettingsModal = document.getElementById('check-settings-modal');
    const apiInputArea = document.getElementById('api-input-area'), addKeyBtn = document.getElementById('add-key-btn');
    const checkStatusDots = document.getElementById('check-status-dots'), checkStatusLog = document.getElementById('check-status-log'), stopCheckBtn = document.querySelector('.stop-check-btn'), checkAccountInfo = document.getElementById('check-account-info');
    const settingsProviderSelect = document.getElementById('settings-provider'), settingsUrlInput = document.getElementById('settings-url'), settingsRequestsInput = document.getElementById('settings-requests'), settingsBodyTextarea = document.getElementById('settings-body'), saveSettingsBtn = document.querySelector('.save-settings-btn'), resetSettingsBtn = document.querySelector('.reset-settings-btn');

    const API_PROVIDERS = {
        'google-ai': { name: 'Google AI (Gemini)', regex: /^AIzaSy[A-Za-z0-9_-]{33}$/, logo: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-blue-500"><path d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.18,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12.18,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.18,22C17.6,22 21.54,18.33 21.54,12.81C21.54,11.76 21.45,11.44 21.35,11.1Z"/></svg>` },
        'hugging-face': { name: 'Hugging Face', regex: /^hf_[A-Za-z0-9]{30,}/, logo: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-yellow-500"><path d="M20.25 14.183C20.25 13.202 19.431 12.383 18.45 12.383C17.469 12.383 16.65 13.202 16.65 14.183C16.65 15.164 17.469 15.983 18.45 15.983C19.431 15.983 20.25 15.164 20.25 14.183ZM15.15 14.183C15.15 13.202 14.331 12.383 13.35 12.383C12.369 12.383 11.55 13.202 11.55 14.183C11.55 15.164 12.369 15.983 13.35 15.983C14.331 15.983 15.15 15.164 15.15 14.183ZM12 2C17.523 2 22 6.477 22 12C22 17.523 17.523 22 12 22C6.477 22 2 17.523 2 12C2 6.477 6.477 2 12 2ZM12 4C7.582 4 4 7.582 4 12C4 16.418 7.582 20 12 20C16.418 20 20 16.418 20 12C20 7.582 16.418 4 12 4ZM8.85 14.183C8.85 13.202 8.031 12.383 7.05 12.383C6.069 12.383 5.25 13.202 5.25 14.183C5.25 15.164 6.069 15.983 7.05 15.983C8.031 15.983 8.85 15.164 8.85 14.183Z"/></svg>` },
        'stability-ai': { name: 'Stability AI', regex: /^sk-[A-Za-z0-9]{40,}/, logo: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-purple-500"><path d="M12 2L9.429 9.429 2 12l7.429 2.571L12 22l2.571-7.429L22 12l-7.429-2.571z"/></svg>` },
        'openai': { name: 'OpenAI', regex: /^sk-[A-Za-z0-9]{20,}/, logo: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-teal-500"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>` },
    };
    
    const CHECK_PROVIDERS_CONFIG = {
        'google-ai': { name: 'Google Gemini', url: 'https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent?key=', body: { content: { parts: [{ text: "Xin chào thế giới" }] } }, authType: 'url' },
        'hugging-face': { name: 'Hugging Face', url: 'https://api-inference.huggingface.co/models/stabilityai/stable-diffusion-xl-base-1.0', body: { inputs: ["Kiểm tra giới hạn API"] }, authType: 'bearer' },
        'stability-ai': { name: 'Stability AI', url: 'https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image', body: { text_prompts: [{ text: "A lighthouse on a cliff" }] }, authType: 'bearer' },
        'openai': { name: 'OpenAI', url: 'https://api.openai.com/v1/chat/completions', body: { model: "gpt-3.5-turbo", messages: [{role: "user", content: "Say this is a test"}]}, authType: 'bearer' },
        'unknown': { name: 'Unknown/Custom', url: '', body: {}, authType: 'bearer' }
    };

    async function apiFetch(endpoint, options = {}) {
        if (!idToken) throw new Error("User not authenticated");
        const fetchOptions = { ...options, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}`, ...options.headers } };
        if (!options.method || options.method.toUpperCase() === 'GET') { fetchOptions.cache = 'no-store'; }
        const response = await fetch(`${BACKEND_URL}${endpoint}`, fetchOptions);
        if (!response.ok) {
            let errorMsg = `Lỗi HTTP! Mã: ${response.status}`;
            try { errorMsg = (await response.json()).error || errorMsg; } catch (e) {}
            throw new Error(errorMsg);
        }
        if (response.status === 204) return null;
        return response.json();
    }
    
    function decodeJwtPayload(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) { console.error("Error decoding JWT", e); return null; }
    }

    function initializeAuthenticatedApp(token) {
        idToken = token;
        const userProfile = decodeJwtPayload(idToken);
        if (!userProfile) { showToast("Không thể giải mã thông tin người dùng."); return; }
        userNameEl.textContent = userProfile.name;
        userAvatarEl.src = userProfile.picture;
        loginView.classList.add('hidden');
        appHeader.classList.remove('hidden'); appHeader.classList.add('flex');
        appContent.classList.remove('hidden');
        loadKeys();
    }

    window.onload = function () {
        const storedIdToken = localStorage.getItem('idToken');
        if (storedIdToken) { initializeAuthenticatedApp(storedIdToken); } 
        else {
            google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse, auto_select: true });
            google.accounts.id.renderButton(gsiButton, { theme: "outline", size: "large", text: "signin_with", shape: "rectangular" });
        }
    };

    function handleCredentialResponse(response) {
        localStorage.setItem('idToken', response.credential);
        initializeAuthenticatedApp(response.credential);
    }

    signOutBtn.addEventListener('click', () => {
        idToken = null;
        localStorage.removeItem('idToken');
        google.accounts.id.disableAutoSelect();
        loginView.classList.remove('hidden');
        appHeader.classList.add('hidden');
        appContent.classList.add('hidden');
        google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse });
        google.accounts.id.renderButton(gsiButton, { theme: "outline", size: "large", text: "signin_with", shape: "rectangular" });
    });

    async function loadKeys() {
        try {
            const keys = await apiFetch('/api/keys');
            allLoadedKeys = keys.map(key => ({ ...key, order: key.order ?? new Date(key.created_at).getTime() }));
            renderKeys(allLoadedKeys);
        } catch (error) { showToast(`Lỗi tải keys: ${error.message}`); }
    }

    function renderKeys(keysToRender) {
        const expandedKeyIds = [...document.querySelectorAll('.key-row.expanded')].map(row => row.dataset.id);
        keyGroupsContainer.innerHTML = '';
        if (!keysToRender || keysToRender.length === 0) {
            keyGroupsContainer.innerHTML = `<p class="text-gray-500 text-center py-10">Bạn chưa có API key nào. Bấm nút <i class="fas fa-plus mx-1"></i> ở góc trên để thêm.</p>`;
            return;
        }
        const groupedKeys = keysToRender.reduce((acc, key) => {
            const type = key.type || 'unknown';
            if (!acc[type]) acc[type] = [];
            acc[type].push(key);
            return acc;
        }, {});
        
        const providerOrder = Object.keys(API_PROVIDERS);
        const sortedProviderTypes = Object.keys(groupedKeys).sort((a, b) => {
            const indexA = providerOrder.indexOf(a);
            const indexB = providerOrder.indexOf(b);
            if (indexA === -1) return 1; if (indexB === -1) return -1;
            return indexA - indexB;
        });

        sortedProviderTypes.forEach(type => {
            const provider = API_PROVIDERS[type] || { name: 'Loại không xác định', logo: '' };
            const keysInGroup = groupedKeys[type].sort((a, b) => (b.favorite ? 1 : 0) - (a.favorite ? 1 : 0) || a.order - b.order);
            
            const groupHeader = document.createElement('h3');
            groupHeader.className = "text-lg font-semibold text-gray-800 flex items-center gap-3";
            groupHeader.innerHTML = `${provider.logo} <span>${provider.name} Keys</span>`;
            keyGroupsContainer.appendChild(groupHeader);

            const groupGrid = document.createElement('div');
            groupGrid.className = "grid grid-cols-1 gap-4";
            
            keysInGroup.forEach(key => {
                const keyRow = keyRowTemplate.content.cloneNode(true).firstElementChild;
                const nameSpan = keyRow.querySelector('.card-name');
                keyRow.dataset.id = key.id;
                keyRow.dataset.value = key.value;
                keyRow.dataset.type = key.type;
                
                nameSpan.textContent = key.name;
                if (key.favorite) {
                    nameSpan.innerHTML = `<i class="fas fa-star text-yellow-400 mr-2"></i>` + nameSpan.innerHTML;
                }
                
                keyRow.querySelector('.card-masked-key').textContent = `${key.value.substring(0, 4)}...${key.value.substring(key.value.length - 4)}`;
                keyRow.querySelector('.card-notes').value = key.notes || '';

                const favoriteBtn = keyRow.querySelector('.favorite-btn');
                if (key.favorite) {
                    favoriteBtn.classList.add('text-yellow-400');
                    favoriteBtn.querySelector('i').classList.replace('far', 'fas');
                }

                keyRow.querySelectorAll('.action-btn').forEach(btn => btn.classList.add('w-10', 'h-10', 'rounded-lg', 'flex', 'items-center', 'justify-center', 'bg-gray-100', 'hover:bg-gray-200', 'transition'));
                
                if (expandedKeyIds.includes(key.id)) {
                    keyRow.classList.add('expanded');
                }
                
                groupGrid.appendChild(keyRow);
            });
            keyGroupsContainer.appendChild(groupGrid);
        });
    }
    
    keyGroupsContainer.addEventListener('click', async (e) => {
        const keyRow = e.target.closest('.key-row');
        if (!keyRow) return;

        keyToModify = allLoadedKeys.find(k => k.id === keyRow.dataset.id);
        if (!keyToModify) return;

        const targetBtn = e.target.closest('button');
        if (!targetBtn && e.target.closest('.key-summary')) {
             keyRow.classList.toggle('expanded');
             return;
        }
        if (!targetBtn) return;

        if (targetBtn.classList.contains('expand-btn')) keyRow.classList.toggle('expanded');
        else if (targetBtn.classList.contains('copy-btn')) copyToClipboard(keyRow.dataset.value);
        else if (targetBtn.classList.contains('favorite-btn')) await updateKey(keyToModify.id, { favorite: !keyToModify.favorite });
        else if (targetBtn.classList.contains('delete-btn')) showModal(deleteConfirmModal);
        else if (targetBtn.classList.contains('check-btn')) runAdvancedCheck(keyToModify);
        else if (targetBtn.classList.contains('settings-btn')) showSettingsModal(keyToModify);
        else if (targetBtn.classList.contains('move-up-btn')) await handleMove(keyToModify.id, 'up');
        else if (targetBtn.classList.contains('move-down-btn')) await handleMove(keyToModify.id, 'down');
    });

    keyGroupsContainer.addEventListener('focusout', async (e) => {
        const keyRow = e.target.closest('.key-row');
        if (!keyRow) return;
        const keyToUpdate = allLoadedKeys.find(k => k.id === keyRow.dataset.id);
        if (!keyToUpdate) return;
        
        const target = e.target;
        if (target.matches('.card-notes')) {
            if (target.value !== (keyToUpdate.notes || '')) await updateKey(keyToUpdate.id, { notes: target.value });
        } else if (target.matches('.card-name')) {
            const newName = target.textContent.trim();
            if (newName && newName !== keyToUpdate.name) await updateKey(keyToUpdate.id, { name: newName });
            else if (!newName) target.textContent = keyToUpdate.name;
        }
    });
    keyGroupsContainer.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.target.matches('.card-name')) { e.preventDefault(); e.target.blur(); }
    });

    function showModal(modal) {
        modal.classList.remove('hidden');
        setTimeout(() => modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0'), 10);
    }

    function hideModal(modal) {
        modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
        keyToModify = null;
    }

    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', e => {
            if (e.target.closest('.close-modal-btn')) {
                hideModal(modal);
            }
            if (e.target === modal && modal.dataset.closeOnOverlay !== 'false') {
                hideModal(modal);
            }
        });
    });

    addKeyModalBtn.addEventListener('click', () => showModal(addKeyModal));
    
    function detectApiKeyType(key) {
        for (const type in API_PROVIDERS) {
            if (API_PROVIDERS[type].regex.test(key)) return type;
        }
        return 'unknown';
    }

    apiInputArea.addEventListener('input', () => {
        addKeyBtn.disabled = apiInputArea.value.trim() === '';
    });

    addKeyBtn.addEventListener('click', async () => {
        const text = apiInputArea.value;
        const lines = text.split('\n').map(line => line.trim()).filter(line => line);
        if (lines.length === 0) return;

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const emailLine = lines.find(line => emailRegex.test(line));
        
        const keyLines = lines.filter(line => !emailRegex.test(line));

        const newKeys = keyLines.map(keyLine => {
            const type = detectApiKeyType(keyLine);
            if (type === 'unknown') return null;
            return {
                id: crypto.randomUUID(),
                name: emailLine ? `${emailLine} ${keyLine.substring(0, 10)}...` : keyLine,
                value: keyLine,
                type: type,
                notes: '',
                favorite: false,
                order: Date.now() + Math.random(),
                checkConfig: null
            };
        }).filter(Boolean);

        if (newKeys.length === 0) {
            showToast("Không tìm thấy API key hợp lệ nào.");
            return;
        }

        addKeyBtn.disabled = true;
        try {
            const savePromises = newKeys.map(key => apiFetch('/api/keys', { method: 'POST', body: JSON.stringify(key) }));
            await Promise.all(savePromises);
            showToast(`Đã lưu thành công ${newKeys.length} key mới!`);
            apiInputArea.value = '';
            hideModal(addKeyModal);
            await loadKeys();
        } catch (error) {
            showToast(`Lỗi khi lưu: ${error.message}`);
        } finally {
            addKeyBtn.disabled = false;
        }
    });

    document.querySelector('.cancel-delete-btn').addEventListener('click', () => hideModal(deleteConfirmModal));
    document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
        if (!keyToModify) return;
        try {
            await apiFetch(`/api/keys/${keyToModify.id}`, { method: 'DELETE' });
            showToast('Đã xóa key.');
            await loadKeys();
        } catch (error) { showToast(`Lỗi xóa key: ${error.message}`); } 
        finally { hideModal(deleteConfirmModal); }
    });
    
    async function updateKey(keyId, updatedData) {
        const keyToUpdate = allLoadedKeys.find(k => k.id === keyId);
        if (!keyToUpdate) { console.error("Key not found:", keyId); return; }
        const payload = { name: keyToUpdate.name, notes: keyToUpdate.notes || '', favorite: keyToUpdate.favorite, order: keyToUpdate.order, checkConfig: keyToUpdate.checkConfig, ...updatedData };
        if (updatedData.checkConfig === null) payload.checkConfig = null;
        try {
            await apiFetch(`/api/keys/${keyId}`, { method: 'PUT', body: JSON.stringify(payload) });
            Object.assign(keyToUpdate, payload);
            renderKeys(allLoadedKeys);
            showToast('Đã lưu thay đổi.');
        } catch (error) { showToast(`Lỗi cập nhật: ${error.message}.`); await loadKeys(); }
    }

    async function fetchAccountInfo(key) {
        checkAccountInfo.classList.add('hidden');
        checkAccountInfo.textContent = '';
        let url, options = { headers: { 'Authorization': `Bearer ${key.value}` } };
        if (key.type === 'hugging-face') url = 'https://huggingface.co/api/whoami-v2';
        else if (key.type === 'stability-ai') url = 'https://api.stability.ai/v1/user/account';
        else return;

        try {
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`Status ${response.status}`);
            const data = await response.json();
            const email = data.email || 'Không tìm thấy email.';
            checkAccountInfo.textContent = `Email tài khoản: ${email}`;
            checkAccountInfo.classList.remove('hidden');
        } catch (error) {
            checkAccountInfo.textContent = `Không thể lấy thông tin tài khoản. Lỗi: ${error.message}`;
            checkAccountInfo.classList.remove('hidden');
        }
    }
    
    async function sendSingleRequest(index, url, options) {
        const dot = document.getElementById(`status-dot-${index}`);
        let retries = 0;
        const maxRetries = 3;

        while (retries <= maxRetries) {
            try {
                const response = await fetch(url, options);
                if (response.status === 503 && options.provider === 'hugging-face' && retries < maxRetries) {
                    const responseData = await response.json();
                    const estimatedTime = responseData.estimated_time || 5;
                    dot.className = 'status-dot status-loading';
                    const waitMsg = `Yêu cầu ${index + 1}: Model đang tải (503). Thử lại sau ${estimatedTime.toFixed(1)}s...`;
                    dot.title = waitMsg;
                    logToCheckModal(waitMsg, 'text-yellow-400');
                    await new Promise(resolve => setTimeout(resolve, (estimatedTime + 0.5) * 1000));
                    retries++;
                    continue;
                }
                
                dot.title = `Yêu cầu ${index + 1}: Status ${response.status} ${response.statusText}`;
                if (response.ok) {
                    dot.className = 'status-dot status-success';
                    logToCheckModal(`Yêu cầu ${index + 1}: Thành công - Status ${response.status}`, 'text-green-400');
                } else if (response.status === 429) {
                    dot.className = 'status-dot status-limited';
                    logToCheckModal(`Yêu cầu ${index + 1}: Bị giới hạn - Status ${response.status}`, 'text-red-400');
                } else {
                    dot.className = 'status-dot status-error';
                    logToCheckModal(`Yêu cầu ${index + 1}: Lỗi - Status ${response.status}`, 'text-orange-400');
                }
                return;
            } catch (error) {
                dot.className = 'status-dot status-error';
                dot.title = `Yêu cầu ${index + 1}: Lỗi mạng`;
                logToCheckModal(`Yêu cầu ${index + 1}: Lỗi mạng - ${error.message}`, 'text-orange-400');
                return;
            }
        }
        dot.className = 'status-dot status-error';
        logToCheckModal(`Yêu cầu ${index + 1}: Thất bại sau ${maxRetries} lần thử lại.`, 'text-orange-400');
    }

    async function runAdvancedCheck(key) {
        isChecking = true;
        await fetchAccountInfo(key);
        const keyConfig = key.checkConfig || CHECK_PROVIDERS_CONFIG[key.type] || CHECK_PROVIDERS_CONFIG['unknown'];
        const requestCount = keyConfig.requestCount || 1;

        showModal(checkStatusModal);
        checkStatusDots.innerHTML = '';
        checkStatusLog.innerHTML = `<p class="text-slate-400">Bắt đầu kiểm tra...</p>`;
        
        for (let i = 0; i < requestCount; i++) {
            const dot = document.createElement('div');
            dot.id = `status-dot-${i}`;
            dot.className = 'status-dot status-pending';
            checkStatusDots.appendChild(dot);
        }

        const finalUrl = keyConfig.authType === 'url' ? keyConfig.url + key.value : keyConfig.url;
        const headers = { 'Content-Type': 'application/json' };
        if (keyConfig.authType === 'bearer') headers['Authorization'] = `Bearer ${key.value}`;
        
        const requestOptions = { method: 'POST', headers: headers, body: JSON.stringify(keyConfig.body), provider: key.type };

        for (let i = 0; i < requestCount; i++) {
            if (!isChecking) { logToCheckModal('Đã dừng kiểm tra.', 'text-yellow-300'); break; }
            await sendSingleRequest(i, finalUrl, requestOptions);
        }
        isChecking = false;
        if (!checkStatusLog.textContent.includes('Đã dừng')) logToCheckModal('Hoàn tất kiểm tra.', 'text-green-300');
    }

    checkAllBtn.addEventListener('click', async () => {
        const loader = document.getElementById('check-all-loader'), icon = checkAllBtn.querySelector('i');
        icon.classList.add('hidden'); loader.classList.remove('hidden'); checkAllBtn.disabled = true;

        for (const row of document.querySelectorAll('.key-row')) {
            const key = allLoadedKeys.find(k => k.id === row.dataset.id);
            if (!key) continue;
            const statusDot = row.querySelector('.status-dot');
            statusDot.className = 'status-dot status-checking';
            const keyConfig = key.checkConfig || CHECK_PROVIDERS_CONFIG[key.type] || CHECK_PROVIDERS_CONFIG['unknown'];
            const finalUrl = keyConfig.authType === 'url' ? keyConfig.url + key.value : keyConfig.url;
            const headers = { 'Content-Type': 'application/json' };
            if (keyConfig.authType === 'bearer') headers['Authorization'] = `Bearer ${key.value}`;
            const requestOptions = { method: 'POST', headers: headers, body: JSON.stringify(keyConfig.body) };
            try {
                const response = await fetch(finalUrl, requestOptions);
                if (response.ok) statusDot.className = 'status-dot status-success';
                else if (response.status === 429) statusDot.className = 'status-dot status-limited';
                else statusDot.className = 'status-dot status-invalid';
            } catch (error) { statusDot.className = 'status-dot status-error'; }
            await new Promise(resolve => setTimeout(resolve, 200));
        }
        icon.classList.remove('hidden'); loader.classList.add('hidden'); checkAllBtn.disabled = false;
        showToast("Đã hoàn tất kiểm tra tất cả các key.");
    });
    
    stopCheckBtn.addEventListener('click', () => { isChecking = false; });
    function logToCheckModal(message, colorClass = 'text-slate-400') {
        const logEntry = document.createElement('p');
        logEntry.className = colorClass;
        logEntry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
        if (checkStatusLog.firstChild?.textContent.includes('Bắt đầu')) checkStatusLog.innerHTML = '';
        checkStatusLog.appendChild(logEntry);
        checkStatusLog.scrollTop = checkStatusLog.scrollHeight;
    }
    
    function showSettingsModal(key) {
        keyToModify = key;
        const config = key.checkConfig || CHECK_PROVIDERS_CONFIG[key.type] || CHECK_PROVIDERS_CONFIG['unknown'];
        settingsProviderSelect.innerHTML = '';
        Object.keys(CHECK_PROVIDERS_CONFIG).forEach(key => {
            if (key === 'unknown') return;
            const option = document.createElement('option');
            option.value = key;
            option.textContent = CHECK_PROVIDERS_CONFIG[key].name;
            settingsProviderSelect.appendChild(option);
        });
        settingsProviderSelect.value = key.type;
        settingsUrlInput.value = config.url || '';
        settingsRequestsInput.value = config.requestCount || 1;
        settingsBodyTextarea.value = config.body ? JSON.stringify(config.body, null, 2) : '';
        showModal(checkSettingsModal);
    }
    
    settingsProviderSelect.addEventListener('change', () => {
        const defaultConfig = CHECK_PROVIDERS_CONFIG[settingsProviderSelect.value];
        if(defaultConfig) {
            settingsUrlInput.value = defaultConfig.url || '';
            settingsBodyTextarea.value = defaultConfig.body ? JSON.stringify(defaultConfig.body, null, 2) : '';
        }
    });

    saveSettingsBtn.addEventListener('click', async () => {
        if (!keyToModify) return;
        let body;
        try { body = settingsBodyTextarea.value ? JSON.parse(settingsBodyTextarea.value) : null; } 
        catch (e) { showToast("Lỗi: JSON trong Request Body không hợp lệ."); return; }
        const newCheckConfig = { url: settingsUrlInput.value, requestCount: parseInt(settingsRequestsInput.value, 10), body: body, authType: CHECK_PROVIDERS_CONFIG[keyToModify.type]?.authType || 'bearer', method: 'POST' };
        await updateKey(keyToModify.id, { checkConfig: newCheckConfig });
        hideModal(checkSettingsModal);
    });
    
    resetSettingsBtn.addEventListener('click', async () => {
        if (!keyToModify) return;
        await updateKey(keyToModify.id, { checkConfig: null });
        hideModal(checkSettingsModal);
    });

    async function handleMove(keyId, direction) {
        const keyToMove = allLoadedKeys.find(k => k.id === keyId);
        if (!keyToMove) return;
        const siblingKeys = allLoadedKeys.filter(k => k.type === keyToMove.type && k.favorite === keyToMove.favorite).sort((a, b) => a.order - b.order);
        const currentIndex = siblingKeys.findIndex(k => k.id === keyId);
        let adjacentIndex = -1;
        if (direction === 'up' && currentIndex > 0) adjacentIndex = currentIndex - 1;
        else if (direction === 'down' && currentIndex < siblingKeys.length - 1) adjacentIndex = currentIndex + 1;
        if (adjacentIndex !== -1) {
            const adjacentKey = siblingKeys[adjacentIndex];
            const tempOrder = keyToMove.order;
            keyToMove.order = adjacentKey.order;
            adjacentKey.order = tempOrder;
            renderKeys(allLoadedKeys.sort((a, b) => a.order - b.order));
            try {
                await Promise.all([ updateKey(keyToMove.id, { order: keyToMove.order }), updateKey(adjacentKey.id, { order: adjacentKey.order }) ]);
            } catch (error) { await loadKeys(); }
        }
    }

    function copyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed'; 
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showToast('Đã sao chép!');
        } catch (err) {
            showToast('Lỗi: Không thể sao chép!');
        }
        document.body.removeChild(textArea);
    }
    function showToast(message) { toast.textContent = message; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }
    </script>
</body>
</html>
