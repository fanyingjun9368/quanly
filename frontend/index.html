<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh Qu·∫£n L√Ω API Key</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-active { background-color: #22c55e; }
        .status-invalid { background-color: #ef4444; }
        .status-limited { background-color: #f59e0b; }
        .status-unknown { background-color: #9ca3af; }
        .status-checking { background-color: #3b82f6; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .toast { visibility: hidden; opacity: 0; transition: visibility 0s 0.5s, opacity 0.5s linear; }
        .toast.show { visibility: visible; opacity: 1; transition: opacity 0.5s linear; }
        .btn-gradient { background-size: 200% auto; transition: background-position 0.5s ease; }
        .btn-gradient:hover { background-position: right center; }
        .loader {
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        .favorite-btn.is-favorite i {
            font-weight: 900; /* Makes the star solid */
            color: #facc15; /* yellow-400 */
        }
        .modal-overlay { transition: opacity 0.3s ease; }

        /* --- CSS T·ªëi ∆∞u h√≥a cho Di ƒë·ªông --- */
        @media (max-width: 768px) {
            .api-group-table thead { display: none; }
            .api-group-table tr {
                display: block;
                border: 1px solid #e5e7eb;
                border-radius: 0.75rem;
                margin-bottom: 1rem;
                padding: 1rem;
                box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            }
            .api-group-table td {
                display: block;
                text-align: right;
                position: relative;
                padding-left: 50%;
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid #f3f4f6;
            }
            .api-group-table tr td:last-child { border-bottom: none; }
            .api-group-table td:before {
                content: attr(data-label);
                position: absolute;
                left: 0.75rem;
                width: 45%;
                padding-right: 0.5rem;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: #4b5563;
            }
            .action-buttons-mobile {
                display: flex;
                flex-wrap: wrap;
                justify-content: flex-end;
                gap: 0.5rem;
            }
            .api-group-table td[data-label="T√™n g·ª£i nh·ªõ"],
            .api-group-table td[data-label="API Key"] {
                padding-left: 0.75rem;
                text-align: left;
            }
            .api-group-table td[data-label="T√™n g·ª£i nh·ªõ"]:before,
            .api-group-table td[data-label="API Key"]:before {
                display: none;
            }

            /* B·ªï sung CSS ƒë·ªÉ thu g·ªçn/m·ªü r·ªông tr√™n di ƒë·ªông */
            .key-row.collapsed-row td:not([data-label="T√™n g·ª£i nh·ªõ"]):not([data-label="API Key"]) {
                display: none !important;
            }
            .key-row .toggle-details-btn .fa-chevron-down {
                transition: transform 0.3s ease;
            }
            .key-row.expanded-row .toggle-details-btn .fa-chevron-down {
                transform: rotate(180deg);
            }

            /* ·∫®n ti√™u ƒë·ªÅ c·ªôt tr√™n mobile theo y√™u c·∫ßu */
            .api-group-table td[data-label="Tr·∫°ng th√°i"]:before,
            .api-group-table td[data-label="Ghi ch√∫"]:before,
            .api-group-table td[data-label="H√†nh ƒë·ªông"]:before {
                display: none;
            }
            /* ƒêi·ªÅu ch·ªânh padding cho c√°c √¥ ƒë√£ ·∫©n data-label */
            .api-group-table td[data-label="Tr·∫°ng th√°i"],
            .api-group-table td[data-label="Ghi ch√∫"],
            .api-group-table td[data-label="H√†nh ƒë·ªông"] {
                padding-left: 0.75rem; /* ƒêi·ªÅu ch·ªânh l·∫°i padding */
                text-align: left; /* CƒÉn tr√°i l·∫°i n·ªôi dung */
            }
        }
    </style>
</head>
<body class="bg-[#fffbbe] text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-7xl"> <!-- TƒÉng max-width cho m√†n h√¨nh l·ªõn -->
        <header id="app-header" class="flex flex-wrap justify-between items-center mb-10 hidden">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900 w-full sm:w-auto mb-4 sm:mb-0">Tr√¨nh Qu·∫£n L√Ω API Key</h1>
            <div id="user-info" class="flex items-center gap-4">
                <div class="text-right"><p id="user-name" class="font-semibold text-gray-900"></p></div>
                <img id="user-avatar" class="w-10 h-10 rounded-full" src="" alt="User Avatar"> <!-- ƒêƒÉng xu·∫•t nh·ªè l·∫°i -->
                
                <!-- N√∫t th√™m API Key m·ªõi -->
                <button id="add-new-key-header-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 flex items-center justify-center gap-1 text-sm md:text-base">
                    <i class="fas fa-plus-circle"></i><span class="hidden md:inline">Th√™m Key</span>
                </button>

                <!-- N√∫t ki·ªÉm tra t·∫•t c·∫£ -->
                <button id="check-all-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg transition flex items-center justify-center gap-1 text-sm md:text-base disabled:bg-gray-400">
                    <i class="fas fa-tasks"></i>
                    <span id="check-all-btn-text" class="hidden md:inline">Ki·ªÉm tra t·∫•t c·∫£</span>
                    <div id="check-all-loader" class="loader hidden"></div>
                </button>

                <button id="sign-out-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg transition text-sm md:text-base">ƒêƒÉng xu·∫•t</button> <!-- ƒêƒÉng xu·∫•t nh·ªè l·∫°i -->
            </div>
        </header>

        <div id="login-view" class="text-center py-20">
             <h1 class="text-4xl font-bold text-gray-900">TRANG QU·∫¢N L√ù API C·ª¶A TR·ª¢ L√ù PMTL.SITE</h1>
            <p class="text-gray-600 mt-2 mb-8">Ph·ª•ng S·ª± Vi√™n Ph√°p M√¥n T√¢m Linh.</p>
            <div id="gsi-button" class="inline-block"></div>
        </div>

        <main id="app-content" class="hidden">
            <!-- Ph·∫ßn th√™m Key m·ªõi ƒë∆∞·ª£c chuy·ªÉn v√†o modal -->
            <div>
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4 sm:mb-0">Danh s√°ch API Keys</h2>
                    <!-- N√∫t ki·ªÉm tra t·∫•t c·∫£ ƒë√£ ƒë∆∞·ª£c chuy·ªÉn l√™n header -->
                </div>
                <!-- V√πng hi·ªÉn th·ªã c√°c nh√≥m API key -->
                <div id="key-groups-container" class="space-y-8">
                    <!-- C√°c nh√≥m API key s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
                </div>
            </div>
        </main>
    </div>

    <!-- Template cho h√†ng API key trong b·∫£ng (ƒê√É THI·∫æT K·∫æ L·∫†I) -->
    <template id="key-row-template">
        <tr class="key-row border-b border-gray-200 hover:bg-gray-50" data-id="" data-value="" data-type="" data-favorite="" data-order="">
            <!-- T√™n g·ª£i nh·ªõ & Y√™u th√≠ch -->
            <td data-label="T√™n g·ª£i nh·ªõ" class="px-4 py-3 align-middle">
                <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <button title="ƒê√°nh d·∫•u y√™u th√≠ch" class="favorite-btn text-gray-400 hover:text-yellow-400 transition-colors flex-shrink-0">
                            <i class="far fa-star text-xl"></i>
                        </button>
                        <span class="card-name font-semibold text-gray-800 break-words" contenteditable="true"></span>
                    </div>
                    <!-- N√∫t b·∫≠t/t·∫Øt chi ti·∫øt tr√™n di ƒë·ªông -->
                    <button class="toggle-details-btn p-2 text-gray-500 hover:text-gray-700 transition-colors md:hidden">
                        <i class="fas fa-chevron-down text-sm"></i>
                    </button>
                </div>
            </td>
            <!-- API Key v√† Tr·∫°ng th√°i (ƒë√£ g·ªôp) -->
            <td data-label="API Key" class="px-4 py-3 align-middle">
                <div class="flex items-center gap-2 mb-2 md:mb-0"> <!-- Th√™m mb-2 ƒë·ªÉ t·∫°o kho·∫£ng c√°ch v·ªõi tr·∫°ng th√°i tr√™n mobile -->
                    <span class="card-masked-key font-mono text-sm text-gray-600"></span>
                    <button title="Sao ch√©p key" class="copy-btn p-2 text-gray-500 hover:text-indigo-600 rounded-lg hover:bg-gray-100 transition-colors flex-shrink-0">
                        <i class="far fa-copy"></i>
                    </button>
                </div>
                <!-- Tr·∫°ng th√°i ƒë∆∞·ª£c chuy·ªÉn l√™n ƒë√¢y -->
                <div class="flex items-center gap-2">
                    <div class="status-dot flex-shrink-0"></div>
                    <p class="card-status-text text-sm text-gray-700 font-medium break-all">Ch∆∞a ki·ªÉm tra</p>
                </div>
            </td>
            <!-- Tr·∫°ng th√°i (c·ªôt c≈©, gi·ªù ·∫©n ƒëi) -->
            <td data-label="Tr·∫°ng th√°i" class="px-4 py-3 align-middle hidden md:table-cell">
                <!-- N·ªôi dung c≈© -->
            </td>
            <!-- Ghi ch√∫ -->
            <td data-label="Ghi ch√∫" class="px-4 py-3 align-middle">
                <textarea class="card-notes w-full bg-transparent p-2 rounded-lg text-sm text-gray-800 border border-transparent hover:border-gray-300 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 transition" rows="1" placeholder="Th√™m ghi ch√∫..."></textarea>
            </td>
            <!-- H√†nh ƒë·ªông -->
            <td data-label="H√†nh ƒë·ªông" class="px-4 py-3 align-middle">
                <div class="flex items-center justify-center gap-1 md:gap-2 action-buttons-mobile">
                    <!-- Move Buttons -->
                    <button title="Di chuy·ªÉn l√™n" class="move-up-btn btn-gradient text-white text-xs font-bold py-2 px-3 rounded-lg transition duration-300 flex items-center justify-center gap-1.5 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button title="Di chuy·ªÉn xu·ªëng" class="move-down-btn btn-gradient text-white text-xs font-bold py-2 px-3 rounded-lg transition duration-300 flex items-center justify-center gap-1.5 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                    <!-- Check Button (gi·ªØ nguy√™n style) -->
                    <button class="check-btn btn-gradient text-white text-xs font-bold py-2 px-3 rounded-lg transition duration-300 flex items-center justify-center gap-1.5"><i class="fas fa-sync-alt"></i><span class="btn-text hidden md:inline">Check</span><div class="loader hidden"></div></button>
                    <!-- Delete Button -->
                    <button title="X√≥a" class="delete-btn btn-gradient text-white text-xs font-bold py-2 px-3 rounded-lg transition duration-300 flex items-center justify-center gap-1.5 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    </template>

    <!-- Toast th√¥ng b√°o nhanh -->
    <div id="toast" class="toast fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-2 px-5 rounded-lg shadow-lg z-50"></div>

    <!-- Modal X√°c nh·∫≠n X√≥a -->
    <div id="delete-confirm-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-900 mb-4">X√°c nh·∫≠n x√≥a</h3>
            <p class="text-gray-600 mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a API key n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">H·ªßy</button>
                <button id="confirm-delete-btn" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">X√≥a</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Chi ti·∫øt Tr·∫°ng th√°i API -->
    <div id="status-details-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div id="modal-header" class="flex justify-between items-center p-4 border-b rounded-t-lg">
                <h3 id="modal-title" class="text-xl font-bold">Chi ti·∫øt Tr·∫°ng th√°i API</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-5">
                <div class="mb-4">
                    <p class="font-semibold text-gray-800">Tr·∫°ng th√°i:</p>
                    <p id="modal-status" class="text-gray-700 p-2 rounded-md font-medium"></p>
                </div>
                <div class="mb-4">
                    <p class="font-semibold text-gray-800">Th√¥ng ƒëi·ªáp t·ª´ API (g·ªëc):</p>
                    <p id="modal-message" class="text-sm text-gray-700 bg-gray-100 p-3 rounded-md font-mono"></p>
                </div>
                <div>
                    <p class="font-semibold text-gray-800">üí° Khuy·∫øn ngh·ªã:</p>
                    <p id="modal-advice" class="text-gray-600"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Th√™m Key M·ªõi -->
    <div id="add-key-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900">Th√™m Key M·ªõi</h2>
                <button id="close-add-key-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label for="modal-api-key-input" class="block text-sm font-medium text-gray-600 mb-1">D√°n API Key v√†o ƒë√¢y</label>
                    <div class="relative">
                        <input type="text" id="modal-api-key-input" placeholder="Key s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông nh·∫≠n di·ªán..." class="w-full bg-gray-50 border-gray-300 rounded-lg py-3 pl-4 pr-10 text-gray-900 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm">
                        <div id="modal-detected-api-logo" class="absolute inset-y-0 right-0 flex items-center pr-3"></div>
                    </div>
                </div>
                <div>
                    <label for="modal-key-name-input" class="block text-sm font-medium text-gray-600 mb-1">T√™n g·ª£i nh·ªõ</label>
                    <input type="text" id="modal-key-name-input" placeholder="V√≠ d·ª•: Project h√¨nh ·∫£nh" class="w-full bg-gray-50 border-gray-300 rounded-lg py-3 px-4 text-gray-900 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            <button id="modal-add-key-btn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                <i class="fas fa-plus-circle mr-2"></i>L∆∞u Key
            </button>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // --- C·∫•u h√¨nh ---
        const GOOGLE_CLIENT_ID = '833528835955-t7pai7q2tb836dqggme3h3560n58s6au.apps.googleusercontent.com';
        const BACKEND_URL = 'https://quanly-backen.onrender.com'; // Gi·∫£ ƒë·ªãnh backend c√≥ endpoint ki·ªÉm tra key
        let idToken = null;
        let keyIdToDelete = null;
        let allLoadedKeys = [];

        const API_PROVIDERS = {
            'google-ai': { name: 'Google AI (Gemini)', regex: /^AIzaSy[A-Za-z0-9_-]{33}$/, logo: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-blue-500"><path d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.18,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12.18,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.18,22C17.6,22 21.54,18.33 21.54,12.81C21.54,11.76 21.45,11.44 21.35,11.1Z"/></svg>`, gradient: 'from-blue-500 to-green-500' },
            'hugging-face': { name: 'Hugging Face', regex: /^hf_[A-Za-z0-9]{30,}/, logo: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-yellow-500"><path d="M20.25 14.183C20.25 13.202 19.431 12.383 18.45 12.383C17.469 12.383 16.65 13.202 16.65 14.183C16.65 15.164 17.469 15.983 18.45 15.983C19.431 15.983 20.25 15.164 20.25 14.183ZM15.15 14.183C15.15 13.202 14.331 12.383 13.35 12.383C12.369 12.383 11.55 13.202 11.55 14.183C11.55 15.164 12.369 15.983 13.35 15.983C14.331 15.983 15.15 15.164 15.15 14.183ZM12 2C17.523 2 22 6.477 22 12C22 17.523 17.523 22 12 22C6.477 22 2 17.523 2 12C2 6.477 6.477 2 12 2ZM12 4C7.582 4 4 7.582 4 12C4 16.418 7.582 20 12 20C16.418 20 20 16.418 20 12C20 7.582 16.418 4 12 4ZM8.85 14.183C8.85 13.202 8.031 12.383 7.05 12.383C6.069 12.383 5.25 13.202 5.25 14.183C5.25 15.164 6.069 15.983 7.05 15.983C8.031 15.983 8.85 15.164 8.85 14.183Z"/></svg>`, gradient: 'from-yellow-500 to-orange-500' },
            'stability-ai': { name: 'Stability AI', regex: /^sk-[A-Za-z0-9]{40,}/, logo: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-purple-500"><path d="M12 2L9.429 9.429 2 12l7.429 2.571L12 22l2.571-7.429L22 12l-7.429-2.571z"/></svg>`, gradient: 'from-purple-500 to-pink-500' },
            'openai': { name: 'OpenAI', regex: /^sk-[A-Za-z0-9]{20,}/, logo: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-teal-500"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>`, gradient: 'from-teal-500 to-cyan-500' },
        };

        async function apiFetch(endpoint, options = {}) {
            if (!idToken) throw new Error("User not authenticated");
            const fetchOptions = {
                ...options,
                headers: { 
                    'Content-Type': 'application/json', 
                    'Authorization': `Bearer ${idToken}`, 
                    ...options.headers 
                },
            };
            if (!options.method || options.method.toUpperCase() === 'GET') {
                fetchOptions.cache = 'no-store';
            }
            let response;
            try {
                response = await fetch(`${BACKEND_URL}${endpoint}`, fetchOptions);
            } catch (networkError) {
                console.error("Network error:", networkError);
                throw new Error("L·ªói m·∫°ng. Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.");
            }
            if (!response.ok) {
                let errorMsg = `L·ªói HTTP! M√£: ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.error || JSON.stringify(errorData);
                } catch (e) {
                    errorMsg = `L·ªói m√°y ch·ªß (M√£: ${response.status}). Kh√¥ng th·ªÉ ƒë·ªçc ph·∫£n h·ªìi.`;
                }
                throw new Error(errorMsg);
            }
            if (response.status === 204) return null;
            try {
                return await response.json();
            } catch (e) {
                if (e instanceof SyntaxError) {
                    console.error("Failed to parse JSON response. Backend might be misconfigured.", e);
                    throw new Error("L·ªói giao ti·∫øp: Backend tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh BACKEND_URL.");
                }
                throw e;
            }
        }

        function decodeJwtPayload(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("Error decoding JWT", e);
                return null;
            }
        }

        function initializeAuthenticatedApp(token) {
            idToken = token;
            const userProfile = decodeJwtPayload(idToken);
            if (!userProfile) {
                showToast("Kh√¥ng th·ªÉ gi·∫£i m√£ th√¥ng tin ng∆∞·ªùi d√πng.");
                return;
            }
            document.getElementById('user-name').textContent = userProfile.name;
            document.getElementById('user-avatar').src = userProfile.picture;
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-header').classList.remove('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            loadKeys();
        }

        window.onload = function () {
            if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID' || BACKEND_URL === 'YOUR_RENDER_BACKEND_URL') {
                document.getElementById('login-view').innerHTML = `<h2 class="text-2xl text-red-500 font-bold">L·ªói C·∫•u H√¨nh Frontend</h2><p class="text-gray-600 mt-2">Vui l√≤ng ƒëi·ªÅn GOOGLE_CLIENT_ID v√† BACKEND_URL trong t·ªáp HTML.</p>`;
                return;
            }
            const storedIdToken = localStorage.getItem('idToken');
            if (storedIdToken) {
                initializeAuthenticatedApp(storedIdToken);
            } else {
                google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse, auto_select: true });
                google.accounts.id.renderButton(document.getElementById("gsi-button"), { theme: "outline", size: "large", text: "signin_with", shape: "rectangular" });
            }
        };

        function handleCredentialResponse(response) {
            localStorage.setItem('idToken', response.credential);
            initializeAuthenticatedApp(response.credential);
        }

        document.getElementById('sign-out-btn').addEventListener('click', () => {
            idToken = null;
            localStorage.removeItem('idToken');
            google.accounts.id.disableAutoSelect();
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('app-header').classList.add('hidden');
            document.getElementById('app-content').classList.add('hidden');
            google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse });
            google.accounts.id.renderButton(document.getElementById("gsi-button"), { theme: "outline", size: "large", text: "signin_with", shape: "rectangular" });
        });

        // C√°c ph·∫ßn t·ª≠ cho Modal Th√™m Key M·ªõi
        const addKeyModal = document.getElementById('add-key-modal');
        const addNewKeyHeaderBtn = document.getElementById('add-new-key-header-btn');
        const closeAddKeyModalBtn = document.getElementById('close-add-key-modal-btn');
        const modalApiKeyInput = document.getElementById('modal-api-key-input');
        const modalKeyNameInput = document.getElementById('modal-key-name-input');
        const modalAddKeyBtn = document.getElementById('modal-add-key-btn');
        const modalDetectedApiLogo = document.getElementById('modal-detected-api-logo');

        const keyGroupsContainer = document.getElementById('key-groups-container');
        const keyRowTemplate = document.getElementById('key-row-template');
        const checkAllBtn = document.getElementById('check-all-btn');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const statusDetailsModal = document.getElementById('status-details-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // S·ª± ki·ªán m·ªü modal th√™m key
        addNewKeyHeaderBtn.addEventListener('click', () => {
            addKeyModal.classList.remove('hidden');
            modalApiKeyInput.value = '';
            modalKeyNameInput.value = '';
            modalDetectedApiLogo.innerHTML = '';
            modalAddKeyBtn.disabled = true;
        });

        // S·ª± ki·ªán ƒë√≥ng modal th√™m key
        closeAddKeyModalBtn.addEventListener('click', () => {
            addKeyModal.classList.add('hidden');
        });

        // Validate form trong modal
        function validateModalForm() {
            const key = modalApiKeyInput.value.trim();
            const name = modalKeyNameInput.value.trim();
            const type = detectApiKeyType(key);
            modalDetectedApiLogo.innerHTML = type !== 'unknown' ? API_PROVIDERS[type].logo : '';
            modalAddKeyBtn.disabled = !(key && name && type !== 'unknown');
        }
        modalApiKeyInput.addEventListener('input', validateModalForm);
        modalKeyNameInput.addEventListener('input', validateModalForm);

        // Th√™m key m·ªõi t·ª´ modal
        modalAddKeyBtn.addEventListener('click', async () => {
            const newKey = {
                id: crypto.randomUUID(),
                name: modalKeyNameInput.value.trim(),
                value: modalApiKeyInput.value.trim(),
                type: detectApiKeyType(modalApiKeyInput.value.trim()),
                notes: '',
                favorite: false,
                order: Date.now(),
                created_at: new Date().toISOString()
            };
            try {
                await apiFetch('/api/keys', { method: 'POST', body: JSON.stringify(newKey) });
                showToast("ƒê√£ th√™m key th√†nh c√¥ng!");
                addKeyModal.classList.add('hidden'); // ƒê√≥ng modal sau khi th√™m
                await loadKeys();
            } catch (error) {
                showToast(`L·ªói: ${error.message}`);
            }
        });


        async function loadKeys() {
            try {
                const keys = await apiFetch('/api/keys');
                allLoadedKeys = keys.map(key => ({
                    ...key,
                    order: key.order ?? new Date(key.created_at).getTime()
                }));
                renderKeys(allLoadedKeys);
            } catch (error) {
                showToast(`L·ªói t·∫£i keys: ${error.message}`);
            }
        }

        function renderKeys(keysToRender) {
            keyGroupsContainer.innerHTML = '';
            if (!keysToRender || keysToRender.length === 0) {
                keyGroupsContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">B·∫°n ch∆∞a c√≥ API key n√†o.</p>`;
                return;
            }
            const groupedKeys = keysToRender.reduce((acc, key) => {
                const type = key.type || 'unknown';
                if (!acc[type]) acc[type] = [];
                acc[type].push(key);
                return acc;
            }, {});
            const sortedProviderTypes = Object.keys(API_PROVIDERS).filter(type => groupedKeys[type]);
            if (groupedKeys['unknown']) sortedProviderTypes.push('unknown');

            sortedProviderTypes.forEach(type => {
                const provider = API_PROVIDERS[type] || { name: 'Lo·∫°i kh√¥ng x√°c ƒë·ªãnh', logo: '' };
                const keysInGroup = groupedKeys[type].sort((a, b) => (b.favorite ? 1 : 0) - (a.favorite ? 1 : 0) || a.order - b.order);
                const groupDiv = document.createElement('div');
                groupDiv.className = 'bg-white p-4 md:p-6 rounded-xl shadow-lg';
                groupDiv.dataset.type = type;

                // --- B·∫¢NG ƒê√É ƒê∆Ø·ª¢C THI·∫æT K·∫æ L·∫†I ---
                groupDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-900 flex items-center gap-3">
                            ${provider.logo}
                            <span>${provider.name} Keys</span>
                        </h3>
                        <button class="check-group-btn w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center gap-2 disabled:bg-gray-400">
                            <i class="fas fa-sync-alt"></i>
                            <span class="btn-text hidden md:inline">Ki·ªÉm tra nh√≥m</span>
                            <div class="loader hidden"></div>
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full api-group-table">
                            <thead class="hidden md:table-header-group bg-gray-50">
                                <tr>
                                    <th scope="col" class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-3/12">T√™n & Y√™u th√≠ch</th>
                                    <th scope="col" class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-2/12">API Key</th>
                                    <th scope="col" class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-2/12">Tr·∫°ng th√°i</th>
                                    <th scope="col" class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-3/12">Ghi ch√∫</th>
                                    <th scope="col" class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider w-2/12">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                `;
                
                const tbody = groupDiv.querySelector('tbody');
                keysInGroup.forEach((key) => {
                    const row = keyRowTemplate.content.cloneNode(true).firstElementChild;
                    row.dataset.id = key.id;
                    row.dataset.value = key.value;
                    row.dataset.type = key.type;
                    row.dataset.favorite = String(key.favorite);
                    row.dataset.order = String(key.order);
                    const nameSpan = row.querySelector('.card-name');
                    nameSpan.textContent = key.name;
                    row.querySelector('.card-masked-key').textContent = `${key.value.substring(0, 4)}...${key.value.substring(key.value.length - 4)}`;
                    row.querySelector('.card-notes').value = key.notes || '';
                    const favoriteBtn = row.querySelector('.favorite-btn');
                    if (key.favorite) {
                        favoriteBtn.classList.add('is-favorite');
                        favoriteBtn.querySelector('i').classList.replace('far', 'fas');
                    }
                    const checkBtn = row.querySelector('.check-btn');
                    const gradientString = provider.gradient || 'from-gray-500 to-gray-600';
                    checkBtn.classList.add('bg-gradient-to-r', ...gradientString.split(' '));
                    const moveUpBtn = row.querySelector('.move-up-btn');
                    const moveDownBtn = row.querySelector('.move-down-btn');
                    const siblingKeys = keysInGroup.filter(k => k.favorite === key.favorite);
                    const currentIndexInSubgroup = siblingKeys.findIndex(k => k.id === key.id);
                    if (currentIndexInSubgroup === 0) moveUpBtn.disabled = true;
                    if (currentIndexInSubgroup === siblingKeys.length - 1) moveDownBtn.disabled = true;
                    updateCardStatus(row, 'unknown', 'Ch∆∞a ki·ªÉm tra');

                    // Th√™m class 'collapsed-row' m·∫∑c ƒë·ªãnh cho mobile
                    if (window.innerWidth <= 768) {
                        row.classList.add('collapsed-row');
                    }

                    tbody.appendChild(row);
                });
                keyGroupsContainer.appendChild(groupDiv);
            });
        }

        function updateCardStatus(row, status, message) {
            const statusDot = row.querySelector('.status-dot');
            const statusText = row.querySelector('.card-status-text');
            statusDot.className = 'status-dot flex-shrink-0';
            statusDot.classList.add(`status-${status || 'unknown'}`);
            statusText.textContent = message || 'Ch∆∞a ki·ªÉm tra';
        }

        function detectApiKeyType(key) {
            for (const type in API_PROVIDERS) {
                if (API_PROVIDERS[type].regex.test(key)) {
                    if (type === 'openai' && API_PROVIDERS['stability-ai'].regex.test(key)) continue; 
                    return type;
                }
            }
            return 'unknown';
        }

        // Lo·∫°i b·ªè validateForm c≈©, gi·ªù s·ª≠ d·ª•ng validateModalForm
        // apiKeyInput.addEventListener('input', validateForm);
        // keyNameInput.addEventListener('input', validateForm);

        // Lo·∫°i b·ªè addKeyBtn c≈©, gi·ªù s·ª≠ d·ª•ng modalAddKeyBtn
        // addKeyBtn.addEventListener('click', async () => { ... });
        
        function copyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('ƒê√£ sao ch√©p v√†o clipboard!');
            } catch (err) {
                showToast('L·ªói: Kh√¥ng th·ªÉ sao ch√©p!');
            }
            document.body.removeChild(textArea);
        }
        
        async function handleMove(keyId, direction) {
            const keyToMove = allLoadedKeys.find(k => k.id === keyId);
            if (!keyToMove) return;
            const siblingKeys = allLoadedKeys
                .filter(k => k.type === keyToMove.type && k.favorite === keyToMove.favorite)
                .sort((a, b) => a.order - b.order);
            const currentIndex = siblingKeys.findIndex(k => k.id === keyId);
            let adjacentIndex = -1;
            if (direction === 'up' && currentIndex > 0) {
                adjacentIndex = currentIndex - 1;
            } else if (direction === 'down' && currentIndex < siblingKeys.length - 1) {
                adjacentIndex = currentIndex + 1;
            }
            if (adjacentIndex !== -1) {
                const adjacentKey = siblingKeys[adjacentIndex];
                const tempOrder = keyToMove.order;
                keyToMove.order = adjacentKey.order;
                adjacentKey.order = tempOrder;
                renderKeys(allLoadedKeys);
                showToast('ƒêang l∆∞u thay ƒë·ªïi v·ªã tr√≠...');
                try {
                    await Promise.all([
                        updateKey(keyToMove.id, { order: keyToMove.order }),
                        updateKey(adjacentKey.id, { order: adjacentKey.order })
                    ]);
                } catch (error) {
                    showToast(`L·ªói s·∫Øp x·∫øp: ${error.message}. ƒêang ho√†n t√°c...`);
                    await loadKeys();
                }
            }
        }
        
        async function updateKey(keyId, updatedData) {
            const keyToUpdate = allLoadedKeys.find(k => k.id === keyId);
            if (!keyToUpdate) {
                console.error("Key not found for update:", keyId);
                return;
            }
            const payload = {
                name: updatedData.name !== undefined ? updatedData.name : keyToUpdate.name,
                notes: updatedData.notes !== undefined ? updatedData.notes : keyToUpdate.notes,
                favorite: updatedData.favorite !== undefined ? updatedData.favorite : keyToUpdate.favorite,
                order: updatedData.order !== undefined ? updatedData.order : keyToUpdate.order,
            };
            try {
                await apiFetch(`/api/keys/${keyId}`, { method: 'PUT', body: JSON.stringify(payload) });
                Object.assign(keyToUpdate, payload); // C·∫≠p nh·∫≠t local state
                renderKeys(allLoadedKeys); // Render l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o UI ƒë·ªìng b·ªô
                showToast('ƒê√£ l∆∞u thay ƒë·ªïi.');
            } catch (error) {
                showToast(`L·ªói c·∫≠p nh·∫≠t: ${error.message}. ƒêang kh√¥i ph·ª•c...`);
                await loadKeys(); // T·∫£i l·∫°i to√†n b·ªô n·∫øu c√≥ l·ªói
            }
        }

        keyGroupsContainer.addEventListener('click', async (e) => {
            const checkGroupBtn = e.target.closest('.check-group-btn');
            if (checkGroupBtn) {
                const groupDiv = checkGroupBtn.closest('.bg-white');
                const groupType = groupDiv.dataset.type;
                setButtonLoading(checkGroupBtn, true);
                const allKeyRowsInGroup = groupDiv.querySelectorAll('.key-row');
                for (const row of allKeyRowsInGroup) {
                    await checkKeyStatus(row, row.dataset.value, row.dataset.type);
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                setButtonLoading(checkGroupBtn, false);
                showToast(`ƒê√£ ho√†n t·∫•t ki·ªÉm tra t·∫•t c·∫£ c√°c key c·ªßa nh√≥m ${API_PROVIDERS[groupType]?.name || groupType}.`);
                return;
            }
            const row = e.target.closest('.key-row');
            if (!row) return;
            const keyId = row.dataset.id;
            const keyToUpdate = allLoadedKeys.find(k => k.id === keyId);
            if (!keyToUpdate) return;

            // X·ª≠ l√Ω s·ª± ki·ªán click n√∫t thu g·ªçn/m·ªü r·ªông
            if (e.target.closest('.toggle-details-btn')) {
                row.classList.toggle('expanded-row');
                row.classList.toggle('collapsed-row');
                e.preventDefault(); // NgƒÉn ch·∫∑n c√°c s·ª± ki·ªán kh√°c
                return; // Tho√°t kh·ªèi h√†m ƒë·ªÉ kh√¥ng x·ª≠ l√Ω c√°c s·ª± ki·ªán kh√°c tr√™n h√†ng
            }

            if (e.target.closest('.favorite-btn')) {
                await updateKey(keyId, { favorite: !keyToUpdate.favorite });
            } else if (e.target.closest('.copy-btn')) {
                copyToClipboard(row.dataset.value);
            } else if (e.target.closest('.delete-btn')) {
                showDeleteConfirmModal(keyId);
            } else if (e.target.closest('.check-btn')) {
                const result = await checkKeyStatus(row, row.dataset.value, row.dataset.type);
                showStatusModal(result);
            } else if (e.target.closest('.move-up-btn')) {
                await handleMove(keyId, 'up');
            } else if (e.target.closest('.move-down-btn')) {
                await handleMove(keyId, 'down');
            }
        });
        
        keyGroupsContainer.addEventListener('focusout', async (e) => {
            const row = e.target.closest('.key-row');
            if (!row) return;
            const keyId = row.dataset.id;
            const keyToUpdate = allLoadedKeys.find(k => k.id === keyId);
            if (!keyToUpdate) return;
            if (e.target.matches('.card-notes')) {
                const newNotes = e.target.value;
                if (newNotes !== (keyToUpdate.notes || '')) {
                    await updateKey(keyId, { notes: newNotes });
                }
            } 
            else if (e.target.matches('.card-name')) {
                const newName = e.target.textContent.trim();
                if (newName && newName !== keyToUpdate.name) {
                    await updateKey(keyId, { name: newName });
                } else if (!newName) {
                    e.target.textContent = keyToUpdate.name;
                }
            }
        });

        keyGroupsContainer.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && (e.target.matches('.card-name') || e.target.matches('.card-notes'))) {
                e.preventDefault();
                e.target.blur();
            }
        });

        function showDeleteConfirmModal(keyId) {
            keyIdToDelete = keyId;
            deleteConfirmModal.classList.remove('hidden');
        }

        function hideDeleteConfirmModal() {
            keyIdToDelete = null;
            deleteConfirmModal.classList.add('hidden');
        }

        cancelDeleteBtn.addEventListener('click', hideDeleteConfirmModal);
        confirmDeleteBtn.addEventListener('click', async () => {
            if (!keyIdToDelete) return;
            try {
                await apiFetch(`/api/keys/${keyIdToDelete}`, { method: 'DELETE' });
                showToast('ƒê√£ x√≥a key.');
                await loadKeys();
            } catch (error) {
                showToast(`L·ªói x√≥a key: ${error.message}`);
            } finally {
                hideDeleteConfirmModal();
            }
        });

        function showStatusModal(result) {
            const { status, title, message, advice } = result;
            const modalTitle = statusDetailsModal.querySelector('#modal-title');
            const modalStatus = statusDetailsModal.querySelector('#modal-status');
            const modalMessage = statusDetailsModal.querySelector('#modal-message');
            const modalAdvice = statusDetailsModal.querySelector('#modal-advice');
            const modalHeader = statusDetailsModal.querySelector('#modal-header');
            modalHeader.className = 'flex justify-between items-center p-4 border-b rounded-t-lg';
            modalTitle.className = 'text-xl font-bold';
            modalTitle.textContent = title;
            modalStatus.textContent = title;
            modalMessage.textContent = message;
            modalAdvice.textContent = advice;
            switch(status) {
                case 'active': modalHeader.classList.add('bg-green-100', 'text-green-800'); break;
                case 'limited': modalHeader.classList.add('bg-yellow-100', 'text-yellow-800'); break;
                case 'invalid': modalHeader.classList.add('bg-red-100', 'text-red-800'); break;
                default: modalHeader.classList.add('bg-gray-100', 'text-gray-800');
            }
            statusDetailsModal.classList.remove('hidden');
        }

        closeModalBtn.addEventListener('click', () => statusDetailsModal.classList.add('hidden'));

        function setButtonLoading(btn, isLoading) {
            const btnText = btn.querySelector('.btn-text');
            const loader = btn.querySelector('.loader');
            btn.disabled = isLoading;
            if (isLoading) {
                if(btnText) btnText.classList.add('hidden');
                if(loader) loader.classList.remove('hidden');
            } else {
                if(btnText) btnText.classList.remove('hidden');
                if(loader) loader.classList.add('hidden');
            }
        }
        
        // H√†m ki·ªÉm tra key m·ªõi, g·ªçi backend
        async function checkKeyStatus(row, key, type) {
            const checkBtn = row.querySelector('.check-btn');
            setButtonLoading(checkBtn, true);
            updateCardStatus(row, 'checking', 'ƒêang ki·ªÉm tra...');
            let result;
            try {
                // Gi·∫£ l·∫≠p cu·ªôc g·ªçi backend ƒë·ªÉ ki·ªÉm tra key
                // Trong th·ª±c t·∫ø, b·∫°n s·∫Ω g·ª≠i key v√† type ƒë·∫øn backend c·ªßa m√¨nh
                // Backend s·∫Ω g·ªçi API c·ªßa nh√† cung c·∫•p (Google, OpenAI,...) v√† tr·∫£ v·ªÅ k·∫øt qu·∫£
                const backendResponse = await fetch(`${BACKEND_URL}/api/check-key`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({ key, type })
                });

                if (backendResponse.ok) {
                    result = await backendResponse.json();
                } else {
                    const errorData = await backendResponse.json();
                    result = { 
                        status: 'invalid', 
                        title: `L·ªói Backend (${backendResponse.status})`, 
                        message: errorData.error || 'C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra key t·ª´ backend.', 
                        advice: 'Vui l√≤ng ki·ªÉm tra log backend ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.' 
                    };
                }
            } catch (error) {
                result = { status: 'invalid', title: 'L·ªói K·∫øt N·ªëi', message: error.message, advice: 'Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng c·ªßa b·∫°n ho·∫∑c URL backend.' };
                console.error(`Error checking ${type} key via backend:`, error);
            }
            setButtonLoading(checkBtn, false);
            updateCardStatus(row, result.status, result.title);
            return result;
        }
        
        // Lo·∫°i b·ªè c√°c h√†m ki·ªÉm tra key ri√™ng l·∫ª (checkGoogleKey, checkStabilityKey, checkHuggingFaceKey, checkOpenAIKey)
        // V√¨ gi·ªù ƒë√¢y ch√∫ng ta s·∫Ω g·ªçi m·ªôt endpoint chung t·ª´ backend.
        /*
        async function getErrorMessage(response) { ... }
        async function checkGoogleKey(key) { ... }
        async function checkStabilityKey(key) { ... }
        async function checkHuggingFaceKey(key) { ... }
        async function checkOpenAIKey(key) { ... }
        */

        checkAllBtn.addEventListener('click', async () => {
            const checkAllBtnText = document.getElementById('check-all-btn-text');
            const checkAllLoader = document.getElementById('check-all-loader');
            checkAllBtn.disabled = true;
            checkAllBtnText.classList.add('hidden');
            checkAllLoader.classList.remove('hidden');
            const allKeyRows = document.querySelectorAll('.key-row');
            for (const row of allKeyRows) {
                await checkKeyStatus(row, row.dataset.value, row.dataset.type);
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            checkAllBtn.disabled = false;
            checkAllBtnText.classList.remove('hidden');
            checkAllLoader.classList.add('hidden');
            showToast("ƒê√£ ho√†n t·∫•t ki·ªÉm tra t·∫•t c·∫£ c√°c key.");
        });

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }
    </script>
</body>
</html>
